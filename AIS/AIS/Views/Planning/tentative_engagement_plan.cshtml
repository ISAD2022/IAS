@{
    ViewData["Title"] = "Tentative Engagement Plan";
    Layout = "_Layout";
}

<script type="text/javascript">
    var g_teams = [];
    var g_branches = [];
    var g_code = 0;
    var g_planId = 0;
    var g_periodId = 0;
    var g_entityType = 0;
    var g_zoneId = 0;
    var g_entityId = 0;
    var g_entityName = '';
    $(document).ready(function () {
        var url_string = window.location;
        var url = new URL(url_string);
        var periodName = url.searchParams.get("period");
        var risk = url.searchParams.get("risk");
        var size = url.searchParams.get("size");
        var entityName = url.searchParams.get("name");
        g_entityName = entityName;
        var freq = url.searchParams.get("freq");
        var days = url.searchParams.get("days");
        g_planId = url.searchParams.get("planId");
        g_code = url.searchParams.get("code");
        g_periodId = url.searchParams.get("periodId");
        g_entityType = url.searchParams.get("entityType");
        g_zoneId = url.searchParams.get("zoneId");
        g_entityId = url.searchParams.get("entityId");
        
        $('#auditperiod_label').text(periodName);
        $('#auditentity_label').text(entityName);
        $('#risk_label').text(risk);
        $('#size_label').text(size);
        $('#frequency_label').text(freq);
        $('#days_label').text(days);      
    });
    function getAutoEndDate() {
        var numAdd = $('#days_label').text();
        var dataAvui = new Date($('#startplan_date').val());
        for (var i = 0; i < numAdd; i++) {
            var dataTemp = dataAvui;
            dataTemp.setDate(dataTemp.getDate() + 1)
            if (dataTemp.getDay() == 6) {
                dataTemp.setDate(dataTemp.getDate() + 2)
            } else if (dataTemp.getDay() == 0) {
                dataTemp.setDate(dataTemp.getDate() + 1)
            }

            dataAvui = dataTemp;

        }
        var month = (dataAvui.getMonth() + 1);
        var day = dataAvui.getDate();
        if (month < 10)
            month = "0" + month;
        if (day < 10)
            day = "0" + day;
        var today = dataAvui.getFullYear() + '-' + month + '-' + day;
        $('#endplan_date').val(today);


        var date = new Date($('#startplan_date').val());
        const lastDayPrevMonth = new Date(date.getFullYear(), date.getMonth(), 0);
        var month = (lastDayPrevMonth.getMonth() + 1);
        var day = lastDayPrevMonth.getDate();
        if (month < 10)
            month = "0" + month;
        if (day < 10)
            day = "0" + day;

        var today = lastDayPrevMonth.getFullYear() + '-' + month + '-' + day;
        $('#endop_date').val(today);
        $.ajax({
            url: "/Planning/get_operational_start_date",
            type: "POST",
            data: {
                'periodId': g_periodId,
                'entityCode': g_code
            },
            cache: false,
            success: function (data) {

                if (data != "" && data.length > 0) {
                    var date = new Date(data);
                    date.setDate(date.getDate() + 1)
                    var month = (date.getMonth()+1);
                    var day = date.getDate();
                    if (month < 10)
                        month = "0" + month;
                    if (day < 10)
                        day = "0" + day;

                    var today = date.getFullYear() + '-' + month + '-' + day;
                    $('#startop_date').val(today);
                }
            }
        });

        
    }
   
    function previewAuditPlan() {

        $('#previewAuditPlan').modal('show');
        $('#auditorDept').text($('#deptSelectionBox option:selected').text());
        $('#auditorPlan').text($('#periodSelectionBox option:selected').text());
        $('#descModal_field').html($('#entitySelectionBox option:selected').text());
        if ($('#deptSelectionBox option:selected').val() == '473') {
            $('#divzone_field').text($('#auditZoneSelectionBox option:selected').text());
            $('#deptBranch_field').text($('#branchSelectionBox option:selected').text());

        } else {
            $('#divzone_field').text($('#divSelectionBox option:selected').text());
            $('#deptBranch_field').text($('#divDeptSelectionBox option:selected').text());

        }
        $('#exeFrom_field').html($('#executionPeriodFromField').val());
        $('#exeTo_field').html($('#executionPeriodToField').val());
        $('#operationalFrom_field').html($('#auditPeriodFromField').val());
        $('#operationalTo_field').html($('#auditPeriodToField').val());
        //
        if ($('#isTravelingRequiredField').is(":checked"))
            $('#travelingReq_field').html('Yes');
        else
            $('#travelingReq_field').html('No');
        $('#remarksAddtn_field').html($('#remarksAdditionalInfoField').val());
        $('#teamName_field').text($('#teamSelectionBox option:selected').text());
        //
        var teamMembersFields = "";
        $.each(g_teams, function (index, team) {
            if (team.name == $('#teamSelectionBox option:selected').text()) {
                if (team.iS_TEAMLEAD == "Y")
                    teamMembersFields += team.employeename + " " + team.teammembeR_ID + " (L)<br>";
                else
                    teamMembersFields += team.employeename + " " + team.teammembeR_ID + " (M)<br>";
            }
        });
        $('#teamMembers_field').html(teamMembersFields);

    }
    function publishNewAuditPlanChanges() {

        if ($('#auditTeam_box').val() == 0) {
            alert('Select audit team');
            return;
        }

        var status = 1;
        var desc = $('#descriptionAuditPlanField').val();


        $.ajax({
            url: "/Planning/add_engagement_plan",
            type: "POST",
            data: {
                'PERIOD_ID': g_periodId,
                'ENTITY_TYPE': g_entityType,
                'PLAN_ID': g_planId,
                'ENTITY_CODE': g_code,
                'ENTITY_ID': g_entityId,
                'ENTITY_NAME': g_entityName,
                'AUDITBY_ID': g_zoneId,
                'AUDIT_STARTDATE': $('#startplan_date').val(),
                'AUDIT_ENDDATE': $('#endplan_date').val(),
                'TEAM_NAME': $('#auditTeam_box option:selected').text(),
                'STATUS': 1,
                'TEAM_ID': $('#auditTeam_box').val(),                
            },
            cache: false,
            success: function (data) {
                alert('Plan has been Created');
                onAlertCallback(redirectToLocation);
                
            },
            dataType: "json",
        });
    }
    function redirectToLocation() {
        window.location.href = "/Planning/tentative_audit_plan";
    }

    function previewSelectedTeaM() {
        if ($('#auditTeam_box').val() == 0) {
            $('#teamPreview').addClass('d-none');
            $('#listOfEmployeeTeam tbody').empty();
        } else {
            $('#teamPreview').removeClass('d-none');
            $('#listOfEmployeeTeam tbody').empty();
            $.ajax({
                url: "/Planning/audit_team",
                type: "POST",
                data: {
                   
                },
                cache: false,
                success: function (data) {
                    var teamId = 0;
                    var teamMembers = [];
                    $.each(data, function (index, team) {
                        if (team.code == $('#auditTeam_box').val()) {

                            if (team.iS_TEAMLEAD == "Y") {
                                $('#listOfEmployeeTeam tbody').append('<tr id=teamcode_' + team.code + '><td class="searchable"><p class="fw-normal mb-1">' + team.name + ' </p></td><td class="searchable"><p class="empName fw-normal mb-1">' + team.employeename + ' (' + team.teammembeR_ID + ') </p></td><td class="empMembers"></td></tr>');
                             } else {
                                teamMembers.push(team);
                                if (team.code != teamId) {
                                    teamId = team.code;
                                }
                            }
                        }
                    });
                    $.each(teamMembers, function (index, team) {
                        if (team.iS_TEAMLEAD != "Y") {
                            prevText = $('#listOfEmployeeTeam tbody #teamcode_' + team.code + ' .empMembers').html();
                            if (prevText != '')
                                prevText += ", ";
                            $('#listOfEmployeeTeam tbody #teamcode_' + team.code + ' .empMembers').text(prevText + team.employeename + '(' + team.teammembeR_ID + ')');
                        }
                    });
                },
                dataType: "json",
            });
        }
        

    }
  
</script>
<div class="row mt-3 col-md-12">
    <h3 style="color: #45c545;">Tentative Engagement Plan</h3>
</div>
<div class="row col-md-12  mt-3">
    <div class="col-md-3">
        <h5>Audit Period</h5>
    </div>
    <div class="col-md-9">
       <label id="auditperiod_label"></label>
    </div>
</div>
<div class="row col-md-12  mt-3">
    <div class="col-md-3">
        <h5>Audit Entity</h5>
    </div>
    <div class="col-md-9">
        <label id="auditentity_label"></label>
    </div>
</div>
<div class="row col-md-12  mt-3">
    <div class="col-md-3">
        <h5>Entity Risk</h5>
    </div>
    <div class="col-md-9">
        <label id="risk_label"></label>
    </div>
</div>
<div class="row col-md-12  mt-3">
    <div class="col-md-3">
        <h5>Entity Size</h5>
    </div>
    <div class="col-md-9">
        <label id="size_label"></label>
    </div>
</div>

<div class="row col-md-12  mt-3">
    <div class="col-md-3">
        <h5>No of Days</h5>
    </div>
    <div class="col-md-9">
        <label id="days_label"></label>
    </div>
</div>
<div class="row col-md-12  mt-3">
    <div class="col-md-3">
        <h5>Frequency</h5>
    </div>
    <div class="col-md-9">
        <label id="frequency_label"></label>
    </div>
</div>.

<div class="row col-md-12 mt-3">
    <div class="col-md-3">
        <h5>Start Date</h5>
    </div>
    <div class="col-md-9">
        <input id="startplan_date"  onchange="getAutoEndDate();" type="date" class="form-control form-select">
    </div>
</div>

<div class="row col-md-12 mt-3">
    <div class="col-md-3">
        <h5>End Date</h5>
    </div>
    <div class="col-md-9">
        <input disabled="disabled" id="endplan_date" type="date"  class="form-control form-select">
    </div>
</div>
<div class="row col-md-12 mt-3">
    <div class="col-md-3">
        <h5>Operational Period Start Date</h5>
    </div>
    <div class="col-md-9">
        <input id="startop_date"  type="date" class="form-control form-select">
    </div>
</div>
<div class="row col-md-12 mt-3">
    <div class="col-md-3">
        <h5>Operational Period End Date</h5>
    </div>
    <div class="col-md-9">
        <input disabled="disabled" id="endop_date"  type="date" class="form-control form-select">
    </div>
</div>

<div class="row col-md-12 mt-3">
    <div class="col-md-3">
        <h5>Team Assigned</h5>
    </div>
    <div class="col-md-9">
        <select id="auditTeam_box" onchange="previewSelectedTeaM();" class="form-select form-control">
            <option value="0" id="0" selected>Select Audit Team</option>
            @{
                if (ViewData["AuditTeamsList"] != null)
                {
                    foreach (var item in (dynamic)(ViewData["AuditTeamsList"]))
                    {
                        if (item.IS_TEAMLEAD == "Y" && item.STATUS == "Y")
                        {
                            <option value="@item.T_ID" id="@item.T_ID">@item.NAME</option>
                        }
                    }
                }
            }

        </select>
        <div id="teamPreview" class="w-100 d-none mt-3">
            <h5 style="color: #45c545;">Team Formation</h5>
            <table id="listOfEmployeeTeam" class="table table-hover table-bordered table-hover mt-3 table-striped">
                <thead style="background-color: rgb(181 229 117 / 93%) !important; ">
                    <tr>
                        <th class="col-md-auto">Team Name</th>
                        <th class="col-md-auto">Team Lead</th>
                        <th class="col-md-auto">Team Members</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row col-md-12 mt-3">
    <div class="col-md-3">
        <h5>Travelling/Travelling Day Required</h5>
    </div>
    <div class="col-md-9">
        <input id="auditCriteriaVisitField" class="form-check" type="checkbox" />
    </div>
</div>
<div class="row col-md-12 mt-4">
   <button onclick="publishNewAuditPlanChanges();" class="col-md-2 btn btn-success">Save Changes</button>
  </div>

