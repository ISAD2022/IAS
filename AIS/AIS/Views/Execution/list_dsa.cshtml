@{
    ViewData["Title"] = "List of DSAs";
    Layout = "_Layout";
}

<script type="text/javascript">
    $(document).ready(function () {
      $.ajax({
        url: g_asiBaseURL + "/ApiCalls/get_draft_dsa_list",
        type: "POST",
        data: {}, // Add data here if necessary
        cache: false,
        success: function (data) {
          if (data.length > 0) {
            var tbody = $('#listofRespPersons tbody');
            tbody.empty();
            destroyDatatable("listofRespPersons");
            $.each(data, function (index, item) {
              if ($('#hiddenUserRoleField').val() == 15) {
                var row = `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${item.entitY_NAME || ''}</td>
                    <td>${item.dsA_NO || ''}</td>
                    <td>${item.heading || ''}</td>
                    <td>${item.resP_PP_NO || ''}</td>
                    <td>${item.emP_NAME || ''}</td>
                    <td>${item.loaN_CASE || ''}</td>
                    <td>${item.lC_AMOUNT || ''}</td>
                    <td>${item.aC_NUMBER || ''}</td>
                    <td>${item.aC_AMOUNT || ''}</td>
                    <td>${item.createD_BY_TEAM || ''}</td>
                    <td>
                      <a onclick="viewDSAContent(${item.id});" href="#" class="text-primary">View Content</a>
                    </td>
                    <td>
                      <a href="#" onclick="forwardSubmissionOfDSAToFAD(${item.id});" class="text-danger">${item.statuS_UP || ''}</a>
                    </td>
                  </tr>`;
                tbody.append(row);
              } else if ($('#hiddenUserRoleField').val() == 5) {
                var row = `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${item.aZ_NAME || ''}</td>
                    <td>${item.entitY_NAME || ''}</td>
                    <td>${item.dsA_NO || ''}</td>
                    <td>${item.heading || ''}</td>
                    <td>${item.resP_PP_NO || ''}</td>
                    <td>${item.emP_NAME || ''}</td>
                    <td>${item.loaN_CASE || ''}</td>
                    <td>${item.lC_AMOUNT || ''}</td>
                    <td>${item.aC_NUMBER || ''}</td>
                    <td>${item.aC_AMOUNT || ''}</td>
                    <td>${item.createD_BY_TEAM || ''}</td>
                    <td>
                      <a onclick="viewDSAContent(${item.id});" href="#" class="text-primary">View Content</a>
                    </td>
                    <td>
                      <a href="#" onclick="refferedBackDSAToAZ(${item.id});" class="text-danger">${item.statuS_DOWN || ''}</a>
                    </td>
                    <td>
                      <a href="#" onclick="forwardSubmissionOfDSAToDPD(${item.id});" class="text-success">${item.statuS_UP || ''}</a>
                    </td>
                  </tr>`;
                tbody.append(row);
              }
              else if ($('#hiddenUserRoleField').val() == 12 && $('#hiddenUserEntityField').val() == "112259") {
                var row = `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${item.aZ_NAME || ''}</td>
                    <td>${item.entitY_NAME || ''}</td>
                    <td>${item.dsA_NO || ''}</td>
                    <td>${item.heading || ''}</td>
                    <td>${item.resP_PP_NO || ''}</td>
                    <td>${item.emP_NAME || ''}</td>
                    <td>${item.loaN_CASE || ''}</td>
                    <td>${item.lC_AMOUNT || ''}</td>
                    <td>${item.aC_NUMBER || ''}</td>
                    <td>${item.aC_AMOUNT || ''}</td>
                    <td>${item.createD_BY_TEAM || ''}</td>
                    <td>
                      <a onclick="viewDSAContent(${item.id});" href="#" class="text-primary">View Content</a>
                    </td>
                    <td>
                      <a href="#" onclick="refferedBackDSAToHeadFAD(${item.id});" class="text-danger">${item.statuS_DOWN || ''}</a>
                    </td>
                    <td>
                      <a href="#" onclick="forwardSubmissionOfDSAToCommittee(${item.id});" class="text-success">${item.statuS_UP || ''}</a>
                    </td>
                  </tr>`;
                tbody.append(row);
              }
            });
            initializeDataTable("listofRespPersons");
          }
        },
        error: function (xhr, status, error) {
          console.error("Error fetching data: ", error);
        },
        dataType: "json",
      });
    });

    function viewDSAContent(id) {
      $('#ViewDSAContent').modal('show');
      $.ajax({
        url: g_asiBaseURL + "/ApiCalls/get_dsa_content",
        type: "POST",
        data: { 'DSA_ID': id },
        cache: false,
        success: function (data) {
          $('#dsa_no_field').val(data.no);
          $('#dsaHeading').val(data.heading);
          $('#dsaContent').html(data.text);
        },
        dataType: "json",
      });
    }
    //SVP AZ ACTION
    function forwardSubmissionOfDSAToFAD(id) {
      $.ajax({
        url: g_asiBaseURL + "/ApiCalls/submit_dsa_to_head_fad",
        type: "POST",
        data: { 'DSA_ID': id },
        cache: false,
        success: function (data) {
          alert(data.Message);
          onAlertCallback(reloadLocation);
        },
        dataType: "json",
      });
    }
    //HEAD FAD ACTION
    function forwardSubmissionOfDSAToDPD(id) {
      $.ajax({
        url: g_asiBaseURL + "/ApiCalls/submit_dsa_to_dpd",
        type: "POST",
        data: { 'DSA_ID': id },
        cache: false,
        success: function (data) {
          alert(data.Message);
          onAlertCallback(reloadLocation);
        },
        dataType: "json",
      });
    }

    function refferedBackDSAToAZ(id) {
      $.ajax({
        url: g_asiBaseURL + "/ApiCalls/reffered_back_by_head_fad",
        type: "POST",
        data: { 'DSA_ID': id },
        cache: false,
        success: function (data) {
          alert(data.Message);
          onAlertCallback(reloadLocation);
        },
        dataType: "json",
      });
    }
    
    //SVP DPD
    function forwardSubmissionOfDSAToCommittee(id) {
      $.ajax({
        url: g_asiBaseURL + "/ApiCalls/submit_dsa_to_committee",
        type: "POST",
        data: { 'DSA_ID': id },
        cache: false,
        success: function (data) {
          alert(data.Message);
          onAlertCallback(reloadLocation);
        },
        dataType: "json",
      });
    }

    function refferedBackDSAToHeadFAD(id) {
      $.ajax({
        url: g_asiBaseURL + "/ApiCalls/reffered_back_by_dpd",
        type: "POST",
        data: { 'DSA_ID': id },
        cache: false,
        success: function (data) {
          alert(data.Message);
          onAlertCallback(reloadLocation);
        },
        dataType: "json",
      });
    }

    function reloadLocation() {
      window.location.reload();
    }
</script>

<div class="row col-md-12 mt-3">
    <h4 style="display: block; color: #45c545;">List of Draft DSAs</h4>
</div>

<input type="hidden" id="hiddenUserRoleField" value="@ViewData["USER_ROLE_ID"]" />
<input type="hidden" id="hiddenUserEntityField" value="@ViewData["USER_ENT_ID"]" />
<div class="row col-md-12 mt-3">

    <table id="listofRespPersons" class="table table-hover table-bordered table-hover mt-3 table-striped">
        <thead style="background-color: rgb(181 229 117 / 93%) !important; ">
            <tr>
                <th class="col-md- auto font-weight-bold">Sr.No</th>

                @{
                    if ((dynamic)ViewData["USER_ROLE_ID"] == 5 || (dynamic)ViewData["USER_ROLE_ID"] == 12)
                    {
                        <th class="col-md- auto font-weight-bold">Audit Zone</th>
                    }
                }
                <th class="col-md- auto font-weight-bold">Entity Name</th>
                <th class="col-md- auto font-weight-bold">DSA No.</th>
                <th class="col-md- auto font-weight-bold">DSA Heading</th>
                <th class="col-md- auto font-weight-bold">Responsible P.P No</th>
                <th class="col-md- auto font-weight-bold">Responsible Person</th>
                <th class="col-md- auto font-weight-bold">Loan Case</th>
                <th class="col-md- auto font-weight-bold">LC Amount</th>
                <th class="col-md- auto font-weight-bold">Account No.</th>
                <th class="col-md- auto font-weight-bold">ACC Amount</th>
                <th class="col-md- auto font-weight-bold">Created By</th>
                <th class="col-md- auto font-weight-bold">Action</th>
                @{
                    if ((dynamic)ViewData["USER_ROLE_ID"] == 15)
                    {
                        <th class="col-md- auto font-weight-bold">Action</th>

                    }
                    else if ((dynamic)ViewData["USER_ROLE_ID"] == 5 || ((dynamic)ViewData["USER_ROLE_ID"] == 12 && (dynamic)ViewData["USER_ENT_ID"] == 112259))
                        {
                        <th class="col-md- auto font-weight-bold">Action</th>
                        <th class="col-md- auto font-weight-bold">Action</th>

                    }

                }

            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<div id="ViewDSAContent" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" style="width:95% !important;" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Content of DSA</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="viewMemo_memo">DSA No.</label>
                        <input id="dsa_no_field" readonly="readonly" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="viewMemo_memo">DSA Heading</label>

                        <textarea id="dsaHeading" readonly="readonly" class="form-control">

                          </textarea>
                    </div>
                    <div class="form-group">
                        <label for="viewMemo_memo">DSA Content</label>
                        <div class="w-100">
                            <div id="dsaContent" class="w-100" style="border: 1px solid grey; border-radius:10px; height:200px; background:#e9ecef; padding:10px;">
                            </div>

                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>




